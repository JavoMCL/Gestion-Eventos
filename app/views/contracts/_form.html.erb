<%= form_with(model: @contract, local: true, class: "needs-validation", html: { novalidate: true }) do |form| %>

  <% if @contract.errors.any? %>
    <div class="alert alert-danger">
      <h4>Errores encontrados:</h4>
      <ul>
        <% @contract.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- CAMPOS PRINCIPALES -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :contract_number, "NÃºmero de Contrato", class: "form-label" %>
      <%= form.text_field :contract_number, class: "form-control", required: true %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :event_id, "Evento asociado", class: "form-label" %>
      <%= form.collection_select :event_id, @events, :id, :name,
                                 { prompt: "Seleccione un evento" },
                                 { class: "form-select" } %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :contract_date, "Fecha de contrato", class: "form-label" %>
      <%= form.date_field :contract_date, class: "form-control", value: Date.current %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :state, "Estado", class: "form-label" %>
      <%= form.select :state, ['Activo', 'Cancelado', 'Completado'],
                      { selected: 'Activo' }, class: "form-select" %>
    </div>
  </div>

  <!-- PANEL PARA AGREGAR DETALLE -->
  <div class="mt-4">
    <label class="form-label fw-bold">Agregar detalle</label>

    <div class="border rounded p-2 mb-3 bg-light">
      <div class="row g-2 align-items-end">

        <div class="col-md-5">
          <label class="form-label">Servicio</label>
          <select id="single_service_select" class="form-select">
            <option value="">Seleccione un servicio</option>
            <% @services.each do |s| %>
              <option value="<%= s.id %>" data-price="<%= s.base_amount %>">
                <%= s.name %>
              </option>
            <% end %>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Cantidad</label>
          <input id="single_quantity" type="number" class="form-control" min="1" value="1">
        </div>

        <div class="col-md-3">
          <label class="form-label">Precio unitario</label>
          <input id="single_price" type="number" class="form-control" step="0.01" min="0" value="0" readonly>
        </div>

        <div class="col-md-2 text-end">
          <button id="add-detail-btn" type="button" class="btn btn-outline-primary w-100">
            <i class="bi bi-plus-circle"></i> Agregar
          </button>
        </div>

        <div class="col-12 mt-2">
          <label class="form-label">Notas</label>
          <textarea id="single_notes" class="form-control" rows="1" placeholder="Notas (opcional)"></textarea>
        </div>
      </div>
    </div>

    <!-- TABLA SIMPLE -->
    <table class="table table-bordered" id="details-table">
      <thead class="table-light">
      <tr>
        <th style="color: #000;">Servicio</th>
        <th style="color: #000;">Cantidad</th>
        <th style="color: #000;">Precio</th>
        <th style="color: #000;">Subtotal</th>
        <th style="color: #000;">Notas</th>
        <th style="color: #000;"></th>
      </tr>
      </thead>

      <tbody id="details-body">
      <% @contract.contract_details.each do |cd| %>
        <% next if cd.service.nil? %>
        <tr data-existing="true">
          <td style="color: #000;"><%= cd.service.name %></td>
          <td style="color: #000;"><%= cd.quantity %></td>
          <td style="color: #000;"><%= cd.unit_price %></td>
          <td style="color: #000;"><%= cd.quantity * cd.unit_price %></td>
          <td style="color: #000;">
            <div class="text-truncate" style="max-width:200px; overflow:hidden; white-space:nowrap;" title="<%= cd.notes %>">
              <%= cd.notes %>
            </div>
          </td>
          <td>
            <%= hidden_field_tag "contract[contract_details_attributes][][id]", cd.id %>
            <%= hidden_field_tag "contract[contract_details_attributes][][_destroy]", 0, class: "destroy-field" %>
            <button type="button" class="btn btn-sm btn-danger remove-row">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

  <!-- TOTAL -->
  <div class="mt-4 mb-3">
    <%= form.label :amount, "Monto total (Gs)", class: "form-label fw-bold" %>
    <%= form.number_field :amount, step: "0.01",
                          class: "form-control fw-bold",
                          id: "total-amount",
                          readonly: true %>
  </div>

  <%= form.submit @contract.new_record? ? 'Crear Contrato' : 'Actualizar Contrato', class: "btn btn-success" %>
  <%= link_to 'Cancelar', contracts_path, class: "btn btn-secondary ms-2" %>

<% end %>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        function actualizarTotal() {
            let total = 0;
            document.querySelectorAll("#details-body tr").forEach(tr => {
                if (tr.style.display === "none") return;
                const subtotal = parseFloat(tr.children[3].innerText) || 0;
                total += subtotal;
            });
            document.getElementById("total-amount").value = total;
        }

        const singleService = document.getElementById("single_service_select");
        singleService.addEventListener("change", function() {
            const price = this.selectedOptions[0].dataset.price || 0;
            document.getElementById("single_price").value = price;
        });

        document.getElementById("add-detail-btn").addEventListener("click", () => {
            const serviceSelect = document.getElementById('single_service_select');
            const serviceId = serviceSelect.value;
            if (!serviceId) return;

            const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
            const quantity = parseFloat(document.getElementById('single_quantity').value) || 1;
            const price = parseFloat(document.getElementById('single_price').value) || 0;
            const notes = document.getElementById('single_notes').value || "";
            const subtotal = quantity * price;

            const tbody = document.getElementById('details-body');
            const row = document.createElement("tr");

            row.innerHTML = `
<td style="color: #000;">${serviceName}</td>
<td style="color: #000;">${quantity}</td>
<td style="color: #000;">${price}</td>
<td style="color: #000;">${subtotal}</td>
<td style="color: #000;">
  <div class="text-truncate" style="max-width:200px; overflow:hidden; white-space:nowrap;" title="${notes}">
    ${notes}
  </div>
</td>
<td>
  <input type="hidden" name="contract[contract_details_attributes][][service_id]" value="${serviceId}">
  <input type="hidden" name="contract[contract_details_attributes][][quantity]" value="${quantity}">
  <input type="hidden" name="contract[contract_details_attributes][][unit_price]" value="${price}">
  <input type="hidden" name="contract[contract_details_attributes][][notes]" value="${notes}">
  <input type="hidden" name="contract[contract_details_attributes][][_destroy]" value="0" class="destroy-field">

  <button type="button" class="btn btn-sm btn-danger remove-row">
    <i class="bi bi-trash"></i>
  </button>
</td>
    `;

            tbody.appendChild(row);

            serviceSelect.value = "";
            document.getElementById('single_quantity').value = 1;
            document.getElementById('single_price').value = 0;
            document.getElementById('single_notes').value = "";

            actualizarTotal();
        });

        document.addEventListener("click", e => {
            const btn = e.target.closest(".remove-row");
            if (!btn) return;

            const tr = btn.closest("tr");
            const destroy = tr.querySelector(".destroy-field");

            if (tr.dataset.existing) {
                destroy.value = 1;
                tr.style.display = "none";
            } else {
                tr.remove();
            }

            actualizarTotal();
        });

        actualizarTotal();
    });
</script>
